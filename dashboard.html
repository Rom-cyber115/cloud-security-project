<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Cloud Security</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <div class="user-info">
                <div class="user-avatar">
                    <div class="user-initial">?</div>
                </div>
                <div>
                    <h2>Memuat data user...</h2>
                    <p>memuat email...</p>
                </div>
            </div>
            <button class="btn btn-logout">
                  Logout
            </button>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3> Status Sistem</h3>
                <p>Semua sistem berjalan normal</p>
                <span class="security-badge" id="statusBadge">MEMUAT...</span>
            </div>
            
            <div class="dashboard-card">
                <h3>üîê Keamanan</h3>
                <p>Level keamanan: Tinggi</p>
                <span class="security-badge" id="securityBadge">TERPROTEKSI</span>
            </div>
            
            <div class="dashboard-card">
                <h3>üìà Aktivitas</h3>
                <p id="lastLoginText">Login terakhir: Memuat...</p>
                <span class="security-badge" id="activityBadge">AKTIF</span>
            </div>
        </div>

        <div class="card">
            <h3>üõ°Ô∏è Detail Keamanan Cloud</h3>
            <div class="features">
                <h4>Fitur yang Sudah Diterapkan:</h4>
                <ul>
                    <li>‚úÖ Firebase Authentication</li>
                    <li>‚úÖ Form Validation & Sanitization</li>
                    <li>‚úÖ Password Strength Checking</li>
                    <li>‚úÖ Show/Hide Password Toggle</li>
                    <li>‚úÖ Session Management</li>
                    <li>‚úÖ Responsive Design</li>
                    <li>‚úÖ Firestore Database</li>
                    <li>‚úÖ User Data Encryption</li>
                </ul>
            </div>

            <div class="features" style="margin-top: 20px; background: #e3f2fd;">
                <h4>üî• Firebase Features Active:</h4>
                <ul>
                    <li>üîê Email/Password Authentication</li>
                    <li>üíæ Cloud Firestore Database</li>
                    <li>üõ°Ô∏è Security Rules</li>
                    <li>üì± Real-time Updates</li>
                    <li>üîí SSL/HTTPS Automatic</li>
                </ul>
            </div>
        </div>

        <div class="tech-stack">
            <h3>Arsitektur Cloud Security:</h3>
            <div class="tech-items">
                <span class="tech-item">Frontend: HTML/CSS/JS</span>
                <span class="tech-item">Authentication: Firebase Auth</span>
                <span class="tech-item">Database: Firestore</span>
                <span class="tech-item">Hosting: Vercel (Ready)</span>
                <span class="tech-item">SSL: Automatic</span>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Your custom scripts -->
    <script src="script.js"></script>
    
    <!-- Dashboard specific script -->
    <script>
        // Check if user is logged in
        async function initDashboard() {
            console.log(" Initializing dashboard...");
            
            const user = await checkAuth();
            
            if (!user) {
                showMessage('Anda harus login terlebih dahulu!', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            console.log("üë§ User logged in:", user);
            
            // Update email immediately
            document.querySelector('.user-info p').textContent = user.email;
            
            // Load user data from Firestore
            const userData = await getUserData(user.uid);
            console.log(" User data from Firestore:", userData);
            
            if (userData.success) {
                // Update user info in header
                const fullName = userData.data.fullName || 'User';
                document.querySelector('.user-info h2').textContent = `Selamat Datang, ${fullName}!`;
                
                // Update avatar with user initial
                const userInitial = fullName.charAt(0).toUpperCase();
                document.querySelector('.user-initial').textContent = userInitial;
                
                // Update security badges
                document.getElementById('statusBadge').textContent = 'AMAN';
                document.getElementById('securityBadge').textContent = 'TERAUTENTIKASI';
                document.getElementById('activityBadge').textContent = 'AKTIF';
                
                // Update last login time
                const lastLogin = userData.data.lastLogin;
                if (lastLogin) {
                    const loginTime = lastLogin.toDate ? lastLogin.toDate() : new Date();
                    const formattedTime = formatTime(loginTime);
                    document.getElementById('lastLoginText').textContent = 
                        `Login terakhir: ${formattedTime}`;
                } else {
                    document.getElementById('lastLoginText').textContent = 
                        `Login terakhir: Baru saja`;
                }
                
                console.log(" Dashboard updated with user data");
                
            } else {
                // Fallback if user data not found in Firestore
                console.log("‚ö†Ô∏è Using fallback user data");
                document.querySelector('.user-info h2').textContent = `Selamat Datang!`;
                document.querySelector('.user-initial').textContent = 'U';
                
                document.getElementById('statusBadge').textContent = 'AMAN';
                document.getElementById('lastLoginText').textContent = `Login terakhir: Baru saja`;
            }
        }

        // Format time function
        function formatTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) {
                return 'Beberapa detik yang lalu';
            } else if (diffMins < 60) {
                return `${diffMins} menit yang lalu`;
            } else if (diffHours < 24) {
                return `${diffHours} jam yang lalu`;
            } else {
                return date.toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        // Logout function
        async function handleLogout() {
            const result = await logoutUser();
            if (result.success) {
                showMessage('Logout berhasil!', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            } else {
                showMessage('Logout gagal: ' + result.error, 'error');
            }
        }

        // Update logout button
        document.querySelector('.btn-logout').addEventListener('click', function(e) {
            e.preventDefault();
            handleLogout();
        });

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log(" Dashboard DOM loaded");
            initDashboard();
        });

        // Show message function for dashboard
        function showMessage(message, type = 'success') {
            // Create message element if not exists
            let messageDiv = document.getElementById('dashboardMessage');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'dashboardMessage';
                messageDiv.className = `message ${type}`;
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    z-index: 1000;
                    min-width: 300px;
                    text-align: center;
                `;
                document.body.appendChild(messageDiv);
            }
            
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            // Auto hide setelah 3 detik
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
    </script>
</body>

</html>
